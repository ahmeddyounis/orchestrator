# Codebase Audit (2026-02-05)

## Scope
- Ran baseline checks: `pnpm build`, `pnpm lint`, `pnpm typecheck`, `pnpm test`.
- Focused on reliability issues that caused agent runs to fail (diff extraction / patch application), plus a targeted security sweep (env propagation + regex safety).

## Fixes Applied

### Reliability: Diff extraction hardening
- **Adapters**: `parseUnifiedDiffFromText` now:
  - Accepts both `<END_DIFF>` and `</END_DIFF>`.
  - Extracts only the unified diff block (ignores preamble/trailing chatter inside markers/fences).
  - De-indents diffs when they’re indented in output.
  - **Preserves whitespace-only context lines** (e.g. a single-space line representing a blank context line in a hunk), which are required for `git apply` to succeed.
- **Core**: `extractUnifiedDiff` now mirrors the above behavior and stops at the end of the diff region instead of consuming trailing non-diff text.

### Reliability: Plan parsing
- Improved plan parsing at the adapter level so section headers (e.g. `1. CODE QUALITY FIXES`) are not treated as executable steps when hierarchical numbering is present.

### Security: Tool subprocess environment propagation
- Tool env propagation (`@orchestrator/exec`) now follows a **baseline + explicit allowlist** model:
  - Always includes `PATH`.
  - Includes a small set of non-secret baseline vars commonly needed by CLIs (e.g. `HOME`, `TMPDIR`, locale).
  - Secrets must be explicitly passed via `execution.toolPolicy.envAllowlist`.

### Security: Regex safety in JS fallback search
- The JS fallback search engine now performs **fixed-string matching only** (escaped regex), delegating regex search to ripgrep.
- Empty query short-circuits to avoid matching everything.

## Follow-ups (Backlog)

### High priority
- **Artifact encryption**: switch from a static salt to a versioned format with per-ciphertext salt (and enforce minimum key strength) in `packages/shared/src/fs/artifacts.ts`.
- **Patch validation**: tighten diff validation to explicitly reject non-diff lines inside diff blocks (defense-in-depth in case a provider returns noisy output).

### Medium priority
- **Provider UX**: document local CLI providers (Gemini / Claude Code / Codex CLI) setup and expected non-interactive flags in `docs/providers/`.
- **PTY stability**: tests show `node-pty` can fail on some Node versions; recommend Node LTS in docs and default `pty: false` unless required.

### Low priority
- Add a lightweight “audit checklist” doc section to `docs/hardening.md` to capture these patterns (diff parsing, env allowlisting, safe regex).
